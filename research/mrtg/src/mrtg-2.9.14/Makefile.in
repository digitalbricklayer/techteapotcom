# things that the GNU standards document suggests all makefiles
# should have.
SHELL=/bin/sh
VER=2.9.14
.SUFFIXES:
.SUFFIXES: .c .o .pl .pm .pod .html .man .wml .1 .txt

prefix = @prefix@
libdir = @libdir@

top_srcdir = @top_srcdir@

# Where is perl 5 on this machine
PERL = @PERL@
CC = @CC@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@
LDFLAGS = @LDFLAGS@
GDFORM_EXT = @GDFORM_EXT@
LD_RUN_PATH = @LD_RUN_PATH@

INSTALL = @INSTALL@
MKINSTALLDIRS = $(SHELL) $(top_srcdir)/mkinstalldirs

all:	 bin/rateup subst

bin/rateup: src/rateup.c
	LD_RUN_PATH=$(LD_RUN_PATH) $(CC) $(CPPFLAGS) $(CFLAGS) src/rateup.c $(LDFLAGS) -o bin/rateup

subst:
	$(PERL) -0777 -pi -e 's@^#!\s*/\S*perl@#! $(PERL)@' bin/cfgmaker bin/indexmaker bin/mrtg
	$(PERL) -0777 -pi -e 's@GRAPHFMT="...";@GRAPHFMT="$(GDFORM_EXT)";@' bin/mrtg bin/indexmaker

clean:
	-rm bin/rateup
	-rm config.cache

install:
	$(MKINSTALLDIRS) $(prefix)/bin
	for x in bin/mrtg bin/cfgmaker bin/indexmaker bin/rateup; do \
	  $(INSTALL) -m 755 $$x $(prefix)/bin; done
	$(MKINSTALLDIRS) $(prefix)/lib/mrtg2/Pod
	for x in lib/mrtg2/*.pm; do \
	  $(INSTALL) -m 644 $$x $(prefix)/lib/mrtg2; done
	for x in lib/mrtg2/Pod/*.pm; do \
	  $(INSTALL) -m 644 $$x $(prefix)/lib/mrtg2/Pod; done
	for x in images/*.gif images/*.png; do \
	  $(INSTALL) -m 644 $$x $(prefix)/lib/mrtg2; done
	$(MKINSTALLDIRS) $(prefix)/doc/mrtg2
	for x in COPYING COPYRIGHT README CHANGES THANKS doc/*.pod doc/*.html doc/*.wml doc/*.txt doc/*.png; do \
	  $(INSTALL) -m 644 $$x $(prefix)/doc/mrtg2; done
	$(MKINSTALLDIRS) $(prefix)/man/man1
	for x in doc/*.1; do \
	  $(INSTALL) -m 644 $$x $(prefix)/man/man1; done

########### Distribution Tools

###
### Things you might NOT want to play with ... 
###

ARCHIVE = mrtg-$(VER)
DIRNAME = mrtg-$(VER)

POD = doc/faq.pod           doc/logfile.pod       doc/nt-guide.pod      doc/unix-guide.pod   \
      doc/forum.pod         doc/mibhelp.pod       doc/reference.pod     doc/webserver.pod    \
      doc/mrtg-rrd.pod      doc/squid.pod         doc/mrtg.pod       doc/contrib.pod \
      doc/cfgmaker.pod      doc/indexmaker.pod    doc/mrtglib.pod

MAN = $(POD:.pod=.1)
TXT = $(POD:.pod=.txt)
HTML = $(POD:.pod=.html) doc/index.html

getpod:
	-rm $(HTML) $(MAN) $(TXT)
	-rm doc/cfgmaker.pod; ln -s ../bin/cfgmaker doc/cfgmaker.pod
	-rm doc/indexmaker.pod;ln -s ../bin/indexmaker doc/indexmaker.pod
	-rm doc/mrtglib.pod;ln -s ../lib/mrtg2/MRTG_lib.pm doc/mrtglib.pod

.pod.1:
	pod2man --release=$(VER) --center=mrtg $<  > $@

.pod.html:
	( cd doc ; pod2html --infile=../$< --outfile=../$@ --noindex --htmlroot=. --podroot=. --podpath=. --title=$* )

.wml.html:
	wmk -f $<

.1.txt:
	@NROFF@ -man -Tascii $< > $@

man: $(MAN)

html: $(HTML)

txt: $(TXT)

versync:
	$(PERL) -i -p -e 's|VERSION\s*=\s*"\d+\.\d+\.\d+([a-z0-9]+)?"|VERSION = "$(VER)"|gi; s|mrtg-\d+\.\d+\.\d+([a-z0-9]+)?|mrtg-$(VER)|gi; s|MRTG\s\d+\.\d+\.\d+([a-z0-9]+)?|MRTG $(VER)|gi' ANNOUNCE bin/mrtg bin/cfgmaker bin/indexmaker lib/mrtg2/*.pm src/*.c doc/*.pod doc/*.wml doc/*.html
	cd translate && $(PERL) mergelocale.pl skeleton.pm0 *.pmd && cp locales_mrtg.pm ../lib/mrtg2

doc:    getpod versync man html txt
	(cd doc; lynx -dump index.html >index.txt)
	$(PERL) -p -e 's|"http://people.ee.ethz.ch/~oetiker/webtools/mrtg/([^"])|"$$1|g' doc/index.html >doc/www-index.html
	$(PERL) -p -e 's|"http://people.ee.ethz.ch/~oetiker/webtools/mrtg/([^"])|"$$1|g' doc/mrtg.html >doc/www-mrtg.html
	$(PERL) -i -p -e 's|\QHREF="././\E|HREF="|g' doc/*.html
	(cd doc; perl -i -p -e 's|<BODY>|<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#990200" VLINK="#006342"><P><IMG SRC="mrtg-l.png"><IMG SRC="mrtg-m.png"><IMG SRC="mrtg-r.gif"></P>|' *.html)

tar:	doc
	autoconf
	gchmod -R u=rwX,go=rX .
	(cd .. ; ln -s AABM-mrtg $(DIRNAME))
	(cd .. ; sed -e "s/^/$(DIRNAME)\//" $(DIRNAME)/MANIFEST | gtar -czv --files-from=- -f $(DIRNAME)/archive/$(ARCHIVE).tar.gz --exclude='*~')
	$(PERL) -0777 -pi -e 's@GRAPHFMT="...";@GRAPHFMT="gif";@' bin/mrtg bin/indexmaker
	(cd .. ; touch $(DIRNAME)/contrib/a~;sed -e "s/^/$(DIRNAME)\//" $(DIRNAME)/MANIFEST | xargs zip -r $(DIRNAME)/archive/$(ARCHIVE).zip; zip $(DIRNAME)/archive/$(ARCHIVE).zip $(DIRNAME)/bin/rateup.exe; zip -d $(DIRNAME)/archive/$(ARCHIVE).zip '*~')
	-rm ../$(DIRNAME)

doc-dist: doc
	scp doc/*.html oetiker@tardis.ee.ethz.ch:public_html/webtools/mrtg/
	scp doc/www-index.html oetiker@tardis.ee.ethz.ch:public_html/webtools/mrtg/readme.html
	scp doc/www-mrtg.html oetiker@tardis.ee.ethz.ch:public_html/webtools/mrtg/mrtg.html

dist: doc-dist tar
	scp CHANGES archive/$(ARCHIVE).* oetiker@tardis.ee.ethz.ch:public_html/webtools/mrtg/pub/
	ssh oetiker@tardis.ee.ethz.ch '(cd public_html/webtools/mrtg/pub; rm mrtg.tar.gz;ln -s $(ARCHIVE).tar.gz mrtg.tar.gz)'

betadist: doc-dist tar
	scp CHANGES archive/$(ARCHIVE).* oetiker@tardis.ee.ethz.ch:public_html/webtools/mrtg/pub/beta
