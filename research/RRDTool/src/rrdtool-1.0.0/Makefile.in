# things that the GNU standards document suggests all makefiles
# should have.
SHELL = /bin/sh
@SET_MAKE@
INSTALL = @INSTALL@
PREFIX = @prefix@
CFLAGS = @CFLAGS@

.SUFFIXES:
.SUFFIXES: .c .o .pl .pm .pod .html .man

all: gd1.3/librrd_gd.a cgilib-0.4/librrd_cgi.a rrdtool perl-piped perl-shared doc

zlib-1.1.3/librrd_z.a:
	(cd zlib-1.1.3 && $(MAKE) CFLAGS="$(CFLAGS)" librrd_z.a)

libpng-1.0.3/librrd_png.a:
	(cd libpng-1.0.3 && $(MAKE) CFLAGS="$(CFLAGS)" librrd_png.a)

gd1.3/librrd_gd.a:
	(cd gd1.3 && $(MAKE) CFLAGS="$(CFLAGS)" librrd_gd.a)

cgilib-0.4/librrd_cgi.a:
	(cd cgilib-0.4 && $(MAKE) CFLAGS="$(CFLAGS)" librrd_cgi.a)

rrdtool: cgilib-0.4/librrd_cgi.a gd1.3/librrd_gd.a zlib-1.1.3/librrd_z.a libpng-1.0.3/librrd_png.a
	(cd src && $(MAKE) CFLAGS="$(CFLAGS)")

dist:
	$(MAKE) -f Makefile.dist

doc:
	-(cd doc && $(MAKE))

perl-piped: perl-piped/Makefile rrdtool
	(cd perl-piped && $(MAKE) OPTIMIZE="$(CFLAGS)")

perl-shared: perl-shared/Makefile rrdtool
	(cd perl-shared && $(MAKE) OPTIMIZE="$(CFLAGS)")

perl-piped/Makefile: perl-piped/Makefile.PL
	(cd perl-piped && @PERL@ Makefile.PL)

perl-shared/Makefile: perl-shared/Makefile.PL
	(cd perl-shared && @PERL@ Makefile.PL)

clean:
	-(cd gd1.3 && $(MAKE) clean)
	-(cd libpng-1.0.3 && $(MAKE) clean)
	-(cd zlib-1.1.3 && $(MAKE) clean)
	-(cd cgilib-0.4 && $(MAKE) clean)
	-(cd src && $(MAKE) clean)
	-rm config.cache
	-(cd perl-shared; @PERL@ Makefile.PL; $(MAKE) clean)
	-(cd perl-piped; @PERL@ Makefile.PL; $(MAKE) clean)


distclean realclean:
	-(cd gd1.3 && $(MAKE) realclean)
	-(cd cgilib-0.4 && $(MAKE) realclean)
	-(cd libpng-1.0.3 && $(MAKE) realclean)
	-(cd zlib-1.1.3 && $(MAKE) realclean)
	-(cd src && $(MAKE) realclean)
	-rm -f config.h config.log config.status Makefile

install: all
	$(INSTALL) -d -m 755 $(PREFIX)/bin
	$(INSTALL) -d -m 755 $(PREFIX)/man/man3
	$(INSTALL) -d -m 755 $(PREFIX)/man/man1
	$(INSTALL) -d -m 755 $(PREFIX)/html
	$(INSTALL) -d -m 755 $(PREFIX)/lib/perl/auto/RRDs
	$(INSTALL) -d -m 755 $(PREFIX)/examples
	$(INSTALL) -d -m 755 $(PREFIX)/contrib
	$(INSTALL) -m 755 src/rrdtool $(PREFIX)/bin
	$(INSTALL) -m 755 src/rrdcgi $(PREFIX)/bin
	$(INSTALL) -m 755 examples/*.pl $(PREFIX)/examples
	$(INSTALL) -m 755 examples/*.cgi $(PREFIX)/examples
	cp -r contrib/* $(PREFIX)/contrib
	$(INSTALL) -m 644 doc/*.3 $(PREFIX)/man/man3
	$(INSTALL) -m 644 doc/*.1 $(PREFIX)/man/man1
	$(INSTALL) -m 644 doc/*.html $(PREFIX)/html
	$(INSTALL) -m 644 perl-piped/RRDp.pm $(PREFIX)/lib/perl
	$(INSTALL) -m 644 perl-shared/RRDs.pm $(PREFIX)/lib/perl
	$(INSTALL) -m 644 perl-shared/blib/arch/auto/RRDs/RRDs.bs $(PREFIX)/lib/perl/auto/RRDs
	$(INSTALL) -m 755 perl-shared/blib/arch/auto/RRDs/RRDs.so $(PREFIX)/lib/perl/auto/RRDs
	@echo "---------------------------------------------------------------------"
	@echo "RRDtool has been installed in $(PREFIX)"
	@echo 
	@echo "* you might want to include $(PREFIX)/bin in your path"
	@echo 
	@echo "* perl scripts using the RRDtool modules should include"
	@echo 
	@echo "   use lib qw($(PREFIX)/lib/perl ); "
	@echo 
	@echo "  at the very start so that perl finds the RRDs modules."
	@echo 
	@echo "* see $(PREFIX)/examples for some demonstration code"
	@echo 
	@echo "---------------------------------------------------------------------"

